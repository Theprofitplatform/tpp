---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => {
    return !data.draft;
  });

  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Handle both pubDate and publishDate for backwards compatibility
const publishDate = post.data.publishDate || post.data.pubDate || new Date();

// Calculate reading time (avg 200 words per minute)
const wordCount = post.body.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.description,
  "datePublished": publishDate.toISOString(),
  "dateModified": post.data.updatedDate ? post.data.updatedDate.toISOString() : publishDate.toISOString(),
  "author": {
    "@type": "Organization",
    "name": post.data.author
  },
  "publisher": {
    "@type": "Organization",
    "name": "The Profit Platform"
  }
};
---

<BaseLayout
  title={post.data.seo?.title || post.data.title}
  description={post.data.seo?.description || post.data.description}
>
  <Header />

  <script type="application/ld+json" set:html={JSON.stringify(schema)} />

  <article class="blog-post">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs" aria-label="Breadcrumb">
      <div class="container-narrow">
        <ol itemscope itemtype="https://schema.org/BreadcrumbList">
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/"><span itemprop="name">Home</span></a>
            <meta itemprop="position" content="1" />
          </li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/blog"><span itemprop="name">Blog</span></a>
            <meta itemprop="position" content="2" />
          </li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span itemprop="name">{post.data.title}</span>
            <meta itemprop="position" content="3" />
          </li>
        </ol>
      </div>
    </nav>

    <header class="post-header">
      <div class="container-narrow">
        <!-- Category Badge -->
        <div class="post-meta-top">
          <span class="category-badge">{post.data.category}</span>
        </div>

        <!-- Title -->
        <h1 class="post-title">{post.data.title}</h1>

        <!-- Description -->
        <p class="post-lead">{post.data.description}</p>

        <!-- Author & Meta -->
        <div class="post-meta">
          <div class="author-info">
            <div class="author-avatar">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
              </svg>
            </div>
            <div class="author-details">
              <span class="author-name">{post.data.author}</span>
              <div class="meta-items">
                <time datetime={publishDate.toISOString()}>
                  {publishDate.toLocaleDateString('en-AU', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  })}
                </time>
                <span class="meta-separator">•</span>
                <span class="reading-time">{readingTime} min read</span>
                <span class="meta-separator">•</span>
                <span class="word-count">{wordCount.toLocaleString()} words</span>
              </div>
            </div>
          </div>

          <!-- Share Buttons -->
          <div class="share-buttons">
            <button class="share-btn" data-share="twitter" aria-label="Share on Twitter">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </button>
            <button class="share-btn" data-share="linkedin" aria-label="Share on LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/>
              </svg>
            </button>
            <button class="share-btn" data-share="facebook" aria-label="Share on Facebook">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10 10 0 0 0 22 12.06C22 6.53 17.5 2.04 12 2.04Z"/>
              </svg>
            </button>
            <button class="share-btn" data-share="copy" aria-label="Copy link">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Tags -->
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="post-tags">
            {post.data.tags.map(tag => (
              <a href={`/blog?tag=${encodeURIComponent(tag)}`} class="tag">#{tag}</a>
            ))}
          </div>
        )}
      </div>
    </header>

    {post.data.coverImage && (
      <div class="cover-image">
        <img src={post.data.coverImage} alt={post.data.title} />
      </div>
    )}

    <div class="container">
      <div class="post-content">
        <Content />
      </div>

      <div class="post-footer">
        <p>Written by <strong>{post.data.author}</strong></p>
        {post.data.updatedDate && (
          <p>Last updated: {post.data.updatedDate.toLocaleDateString('en-AU')}</p>
        )}
      </div>

      <aside class="post-cta">
        <h3>Ready to grow your business?</h3>
        <p>Let's talk about how we can help you achieve results like these.</p>
        <a href="/contact" class="cta-button">Schedule a Free Consultation</a>
      </aside>
    </div>
  </article>
</BaseLayout>

<style>
  /* Breadcrumbs */
  .breadcrumbs {
    background: #f8f9fa;
    padding: 1rem 0;
    margin-top: 95px;
    border-bottom: 1px solid #e9ecef;
  }

  .breadcrumbs ol {
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
    margin: 0;
    padding: 0;
  }

  .breadcrumbs li {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    color: #6c757d;
  }

  .breadcrumbs li:not(:last-child)::after {
    content: '›';
    margin-left: 0.5rem;
    color: #adb5bd;
    font-weight: 600;
  }

  .breadcrumbs a {
    color: #667eea;
    text-decoration: none;
    transition: color 0.2s;
  }

  .breadcrumbs a:hover {
    color: #5568d3;
    text-decoration: underline;
  }

  .breadcrumbs li:last-child span {
    color: #495057;
    font-weight: 500;
  }

  /* Container */
  .container-narrow {
    max-width: 920px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  /* Post Header */
  .post-header {
    position: relative;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3.5rem 0;
  }

  .post-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background:
      radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(255,255,255,0.08) 0%, transparent 50%);
    pointer-events: none;
  }

  .post-header > * {
    position: relative;
    z-index: 1;
  }

  .post-meta-top {
    margin-bottom: 1.5rem;
  }

  .category-badge {
    display: inline-block;
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 0.4rem 1rem;
    border-radius: 50px;
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 1px;
    font-size: 0.75rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .post-title {
    font-size: clamp(2rem, 5vw, 3.5rem);
    margin: 1.5rem 0 1rem;
    line-height: 1.15;
    font-weight: 800;
    letter-spacing: -0.02em;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .post-lead {
    font-size: clamp(1.125rem, 2vw, 1.375rem);
    line-height: 1.6;
    opacity: 0.95;
    margin-bottom: 2rem;
    font-weight: 400;
  }

  /* Author & Meta */
  .post-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1.5rem;
    padding: 1.5rem 0;
    border-top: 1px solid rgba(255,255,255,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.2);
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .author-avatar {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255,255,255,0.3);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .author-avatar svg {
    width: 28px;
    height: 28px;
    opacity: 0.9;
  }

  .author-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .author-name {
    font-weight: 600;
    font-size: 1rem;
    opacity: 0.95;
  }

  .meta-items {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    opacity: 0.85;
  }

  .meta-separator {
    opacity: 0.5;
  }

  /* Share Buttons */
  .share-buttons {
    display: flex;
    gap: 0.75rem;
  }

  .share-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
  }

  .share-btn svg {
    width: 18px;
    height: 18px;
    opacity: 0.9;
  }

  .share-btn:hover {
    background: rgba(255,255,255,0.35);
    border-color: rgba(255,255,255,0.5);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  /* Tags */
  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .post-tags .tag {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255,255,255,0.25);
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    color: white;
    transition: all 0.3s;
  }

  .post-tags .tag:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-1px);
  }

  .cover-image {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1.5rem;
  }

  .cover-image img {
    width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .post-content {
    max-width: 800px;
    margin: 3rem auto;
    line-height: 1.8;
    font-size: 1.125rem;
  }

  .post-content :global(h2) {
    font-size: 2rem;
    margin-top: 3rem;
    margin-bottom: 1rem;
    color: #333;
  }

  .post-content :global(h3) {
    font-size: 1.5rem;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: #555;
  }

  .post-content :global(p) {
    margin: 1.5rem 0;
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin: 1.5rem 0;
    padding-left: 2rem;
  }

  .post-content :global(li) {
    margin: 0.75rem 0;
  }

  .post-content :global(code) {
    background: #f4f4f4;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
  }

  .post-content :global(pre) {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 1.5rem;
    border-radius: 6px;
    overflow-x: auto;
    margin: 2rem 0;
  }

  .post-content :global(blockquote) {
    border-left: 4px solid #667eea;
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: #666;
  }

  .post-footer {
    max-width: 800px;
    margin: 3rem auto;
    padding-top: 2rem;
    border-top: 1px solid #e9ecef;
    color: #666;
  }

  .post-cta {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    margin: 3rem auto;
    max-width: 600px;
  }

  .post-cta h3 {
    margin-bottom: 0.5rem;
    color: #333;
  }

  .cta-button {
    display: inline-block;
    background: #667eea;
    color: white;
    padding: 1rem 2rem;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    margin-top: 1rem;
    transition: background 0.3s;
  }

  .cta-button:hover {
    background: #5568d3;
  }

  /* Mobile */
  @media (max-width: 768px) {
    .container-narrow {
      padding: 0 1.25rem;
    }

    .breadcrumbs {
      padding: 0.75rem 0;
    }

    .breadcrumbs li {
      font-size: 0.8125rem;
    }

    .post-header {
      padding: 2.5rem 0;
    }

    .post-title {
      margin: 1rem 0 0.75rem;
    }

    .post-meta {
      flex-direction: column;
      align-items: flex-start;
    }

    .share-buttons {
      width: 100%;
      justify-content: flex-start;
    }

    .post-tags {
      margin-top: 1rem;
    }

    .post-content {
      font-size: 1.0625rem;
    }

    .post-content :global(h2) {
      font-size: 1.75rem;
      margin-top: 2.5rem;
    }

    .post-content :global(h3) {
      font-size: 1.375rem;
      margin-top: 1.75rem;
    }

    .cover-image {
      margin: 1.5rem auto;
    }
  }
</style>

<script>
  // Social sharing functionality
  document.addEventListener('DOMContentLoaded', () => {
    const shareButtons = document.querySelectorAll('.share-btn');
    const postTitle = document.querySelector('.post-title')?.textContent || '';
    const postURL = window.location.href;

    shareButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const platform = btn.getAttribute('data-share');

        switch(platform) {
          case 'twitter':
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(postTitle)}&url=${encodeURIComponent(postURL)}`, '_blank', 'width=550,height=420');
            break;

          case 'linkedin':
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(postURL)}`, '_blank', 'width=550,height=420');
            break;

          case 'facebook':
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(postURL)}`, '_blank', 'width=550,height=420');
            break;

          case 'copy':
            navigator.clipboard.writeText(postURL).then(() => {
              const originalHTML = btn.innerHTML;
              btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
              btn.style.background = 'rgba(76, 175, 80, 0.3)';

              setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '';
              }, 2000);
            });
            break;
        }
      });
    });
  });
</script>
