---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';

const apiUrl = '';
---

<BaseLayout title="Free Keyword Gap Analyzer | Find Keywords You're Missing">
  <Header />

  <main id="main-content" role="main">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs" aria-label="Breadcrumb">
      <div class="container">
        <ol itemscope itemtype="https://schema.org/BreadcrumbList">
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/">
              <span itemprop="name">Home</span>
            </a>
            <meta itemprop="position" content="1" />
          </li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a itemprop="item" href="/tools">
              <span itemprop="name">Free Tools</span>
            </a>
            <meta itemprop="position" content="2" />
          </li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span itemprop="name">Keyword Gap Analyzer</span>
            <meta itemprop="position" content="3" />
          </li>
        </ol>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
      <div class="container">
        <div class="hero-content">
          <span class="section-tag">ðŸŽ¯ Free Competitive Intelligence</span>
          <h1>Find Keywords Your Competitors Rank For<br><span class="highlight">That You Don't</span></h1>
          <p class="hero-subtitle">
            Discover the exact keywords driving traffic to your Sydney competitors.
            See the "easy wins" you can rank for in 30-90 days.
          </p>
          <div class="trust-badges">
            <span class="badge"><i class="fas fa-check-circle"></i> Real SERP Data</span>
            <span class="badge"><i class="fas fa-bolt"></i> Easy Win Scoring</span>
            <span class="badge"><i class="fas fa-gift"></i> 100% Free</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Tool Section -->
    <section class="tool-section">
      <div class="container">
        <div class="tool-card">

          <!-- FORM STATE -->
          <div id="formState">
            <form id="keywordGapForm" class="gap-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="yourDomain">
                    <i class="fas fa-home"></i>
                    Your Website
                  </label>
                  <input
                    type="url"
                    id="yourDomain"
                    name="yourDomain"
                    placeholder="yourwebsite.com.au"
                    required
                  />
                </div>

                <div class="vs-divider">VS</div>

                <div class="form-group">
                  <label for="competitorDomain">
                    <i class="fas fa-crosshairs"></i>
                    Competitor Website
                  </label>
                  <input
                    type="url"
                    id="competitorDomain"
                    name="competitorDomain"
                    placeholder="competitor.com.au"
                    required
                  />
                </div>
              </div>

              <button type="submit" class="btn-primary" id="analyzeButton">
                <span class="btn-text">
                  <i class="fas fa-search"></i>
                  Find Keyword Gaps
                </span>
                <span class="btn-loader" style="display: none;">
                  <i class="fas fa-spinner fa-spin"></i>
                  Analyzing...
                </span>
              </button>

              <p class="form-note">
                <i class="fas fa-lock"></i> No signup required for top 3 opportunities
              </p>
            </form>
          </div>

          <!-- LOADING STATE -->
          <div id="loadingState" class="loading-state" style="display: none;">
            <div class="loader-animation">
              <div class="scanning-line"></div>
              <i class="fas fa-chart-bar fa-3x"></i>
            </div>
            <h3>Analyzing Your Keyword Gap...</h3>
            <div class="progress-steps">
              <div class="step active" id="step1">
                <i class="fas fa-check-circle"></i>
                <span>Crawling websites</span>
              </div>
              <div class="step" id="step2">
                <i class="fas fa-circle"></i>
                <span>Extracting topics & services</span>
              </div>
              <div class="step" id="step3">
                <i class="fas fa-circle"></i>
                <span>Checking SERP positions</span>
              </div>
              <div class="step" id="step4">
                <i class="fas fa-circle"></i>
                <span>Scoring opportunities</span>
              </div>
            </div>
          </div>

          <!-- RESULTS STATE -->
          <div id="resultsState" style="display: none;">

            <!-- Results Header -->
            <div class="results-header">
              <div class="domain-comparison-mini">
                <span class="domain-mini" id="yourDomainMini">--</span>
                <span class="vs-mini">VS</span>
                <span class="domain-mini competitor" id="competitorDomainMini">--</span>
              </div>
            </div>

            <!-- Main Stats -->
            <div class="main-stats">
              <div class="stat-card highlight">
                <div class="stat-number" id="totalGaps">--</div>
                <div class="stat-label">Keywords They Rank For<br>That You Don't</div>
              </div>
              <div class="stat-card success">
                <div class="stat-number" id="easyWins">--</div>
                <div class="stat-label">"Easy Win"<br>Opportunities</div>
              </div>
              <div class="stat-card value">
                <div class="stat-number" id="totalValue">--</div>
                <div class="stat-label">Est. Monthly<br>Traffic Value</div>
              </div>
            </div>

            <!-- Top 3 Opportunities -->
            <div class="opportunities-section">
              <h2><i class="fas fa-trophy"></i> Your Top 3 Opportunities</h2>
              <p class="section-subtitle">These are the highest-value keywords you can realistically rank for</p>

              <div id="opportunitiesList">
                <!-- Populated by JS -->
              </div>
            </div>

            <!-- Email Gate -->
            <div class="email-gate" id="emailGate">
              <div class="gate-content">
                <i class="fas fa-lock-open fa-3x"></i>
                <h3>Want the Full List?</h3>
                <p>Get all <span id="fullListCount">10</span> keyword opportunities + implementation roadmap</p>

                <form id="emailForm" class="email-form">
                  <input
                    type="email"
                    id="email"
                    name="email"
                    placeholder="your@email.com"
                    required
                  />
                  <button type="submit" class="btn-primary">
                    Get Full Report
                  </button>
                </form>

                <p class="privacy-note">
                  <i class="fas fa-shield-alt"></i> We'll email you the report. No spam, unsubscribe anytime.
                </p>
              </div>
            </div>

            <!-- Full List (shown after email) -->
            <div class="full-opportunities" id="fullOpportunities" style="display: none;">
              <h2><i class="fas fa-list"></i> Complete Keyword Gap Analysis</h2>
              <div id="fullOpportunitiesList">
                <!-- Populated by JS -->
              </div>
            </div>

            <!-- Upgrade CTA -->
            <div class="upgrade-cta">
              <div class="cta-content">
                <div class="cta-icon">
                  <i class="fas fa-rocket"></i>
                </div>
                <div class="cta-text">
                  <h3>Ready to Dominate These Keywords?</h3>
                  <p>Get a custom implementation roadmap + strategy call with our Sydney SEO team</p>
                  <div class="cta-value">
                    <span class="value-old">$997 value</span>
                    <span class="value-new">FREE Strategy Session</span>
                  </div>
                </div>
                <div class="cta-actions">
                  <a href="/contact" class="btn-cta-primary">
                    <span>Book Free Strategy Call</span>
                    <i class="fas fa-arrow-right"></i>
                  </a>
                  <a href="tel:+61487286451" class="btn-cta-secondary">
                    <i class="fas fa-phone"></i>
                    <span>Call Now: 0487 286 451</span>
                  </a>
                </div>
              </div>
            </div>

            <!-- New Analysis Button -->
            <div class="new-analysis">
              <button class="btn-secondary" id="newAnalysisButton">
                <i class="fas fa-redo"></i> Analyze Another Competitor
              </button>
            </div>

          </div>

          <!-- ERROR STATE -->
          <div id="errorState" class="error-state" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-3x"></i>
            <h3>Analysis Failed</h3>
            <p id="errorMessage"></p>
            <button class="btn-primary" id="tryAgainButton">
              <i class="fas fa-redo"></i> Try Again
            </button>
          </div>

        </div>
      </div>
    </section>

    <!-- How It Works -->
    <section class="how-it-works">
      <div class="container">
        <h2>How It Works</h2>
        <div class="steps-grid">
          <div class="step-card">
            <div class="step-icon">1</div>
            <h3>We Crawl Both Sites</h3>
            <p>Extract topics, services, and content to understand your niche</p>
          </div>
          <div class="step-card">
            <div class="step-icon">2</div>
            <h3>Check Real SERPs</h3>
            <p>See where your competitor ranks in Sydney Google searches</p>
          </div>
          <div class="step-card">
            <div class="step-icon">3</div>
            <h3>Find the Gaps</h3>
            <p>Identify keywords they rank for that you don't</p>
          </div>
          <div class="step-card">
            <div class="step-icon">4</div>
            <h3>Score "Easy Wins"</h3>
            <p>Show you the keywords you can realistically rank for</p>
          </div>
        </div>
      </div>
    </section>

  </main>
</BaseLayout>

<style>
  /* Container */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* Breadcrumbs */
  .breadcrumbs {
    padding: 140px 0 20px;
    background: #f8fafc;
  }

  .breadcrumbs ol {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
    font-size: 0.9rem;
  }

  .breadcrumbs li {
    display: flex;
    align-items: center;
    color: #64748b;
  }

  .breadcrumbs li:not(:last-child)::after {
    content: "â€º";
    margin-left: 0.5rem;
    color: #cbd5e1;
  }

  .breadcrumbs a {
    color: #f59e0b;
    text-decoration: none;
  }

  .breadcrumbs a:hover {
    text-decoration: underline;
  }

  /* Hero */
  .hero {
    padding: 60px 0;
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    color: white;
    text-align: center;
  }

  .hero-content {
    display: block;
  }

  .section-tag {
    display: inline-block;
    padding: 0.5rem 1.25rem;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .hero h1 {
    font-size: 3rem;
    font-weight: 900;
    margin: 1rem 0;
    line-height: 1.2;
  }

  .highlight {
    color: #fbbf24;
  }

  .hero-subtitle {
    font-size: 1.25rem;
    opacity: 0.95;
    max-width: 700px;
    margin: 0 auto 2rem;
    line-height: 1.6;
  }

  .trust-badges {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .badge {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  /* Tool Section */
  .tool-section {
    padding: 80px 0;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  }

  .tool-card {
    background: white;
    border-radius: 20px;
    padding: 3rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    max-width: 900px;
    margin: 0 auto;
  }

  /* Form */
  .gap-form {
    margin-bottom: 2rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 2rem;
    align-items: end;
    margin-bottom: 2rem;
  }

  .vs-divider {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 1.1rem;
    margin-bottom: 10px;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #1e293b;
    font-size: 1rem;
  }

  .form-group label i {
    color: #3b82f6;
    margin-right: 0.5rem;
  }

  .form-group input {
    width: 100%;
    padding: 1rem 1.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .btn-primary {
    width: 100%;
    padding: 1.25rem 2rem;
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .form-note {
    text-align: center;
    margin-top: 1rem;
    color: #64748b;
    font-size: 0.9rem;
  }

  .form-note i {
    color: #10b981;
  }

  /* Loading State */
  .loading-state {
    text-align: center;
    padding: 3rem 0;
  }

  .loader-animation {
    position: relative;
    display: inline-block;
    margin-bottom: 2rem;
  }

  .loader-animation i {
    color: #3b82f6;
    animation: pulse 2s ease-in-out infinite;
  }

  .scanning-line {
    position: absolute;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, transparent, #3b82f6, transparent);
    top: 50%;
    animation: scan 2s linear infinite;
  }

  @keyframes scan {
    0% { transform: translateY(-50%) translateX(-100%); }
    100% { transform: translateY(-50%) translateX(100%); }
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }

  .progress-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 400px;
    margin: 2rem auto 0;
    text-align: left;
  }

  .step {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    color: #94a3b8;
  }

  .step.active {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
  }

  .step.complete {
    color: #10b981;
  }

  /* Results */
  .results-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid #f1f5f9;
  }

  .domain-comparison-mini {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    font-size: 1.1rem;
  }

  .domain-mini {
    font-weight: 700;
    color: #1e40af;
  }

  .domain-mini.competitor {
    color: #ef4444;
  }

  .vs-mini {
    color: #94a3b8;
    font-weight: 900;
  }

  .main-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .stat-card {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    border: 2px solid #e2e8f0;
  }

  .stat-card.highlight {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-color: #3b82f6;
  }

  .stat-card.success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    border-color: #10b981;
  }

  .stat-card.value {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-color: #f59e0b;
  }

  .stat-number {
    font-size: 3rem;
    font-weight: 900;
    color: #1e293b;
    margin-bottom: 0.5rem;
  }

  .stat-label {
    font-size: 0.9rem;
    color: #64748b;
    font-weight: 600;
    line-height: 1.4;
  }

  /* Opportunities */
  .opportunities-section {
    margin-bottom: 3rem;
  }

  .opportunities-section h2 {
    font-size: 2rem;
    font-weight: 900;
    color: #1e293b;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-subtitle {
    color: #64748b;
    margin-bottom: 2rem;
  }

  .opportunity-card {
    background: white;
    border: 3px solid #e2e8f0;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
  }

  .opportunity-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
  }

  .opportunity-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1.5rem;
  }

  .opportunity-rank {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    color: white;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 900;
    flex-shrink: 0;
  }

  .opportunity-main {
    flex: 1;
    padding-left: 1.5rem;
  }

  .keyword-text {
    font-size: 1.5rem;
    font-weight: 800;
    color: #1e293b;
    margin-bottom: 1rem;
  }

  .opportunity-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .metric {
    background: #f8fafc;
    padding: 1rem;
    border-radius: 8px;
  }

  .metric-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e40af;
    margin-bottom: 0.25rem;
  }

  .metric-label {
    font-size: 0.8rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .easy-win-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 700;
    margin-top: 1rem;
  }

  /* Email Gate */
  .email-gate {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-radius: 16px;
    padding: 3rem;
    text-align: center;
    margin: 3rem 0;
  }

  .gate-content i {
    color: #3b82f6;
    margin-bottom: 1rem;
  }

  .gate-content h3 {
    font-size: 2rem;
    font-weight: 900;
    color: #1e293b;
    margin-bottom: 1rem;
  }

  .gate-content p {
    font-size: 1.1rem;
    color: #475569;
    margin-bottom: 2rem;
  }

  .email-form {
    display: flex;
    gap: 1rem;
    max-width: 500px;
    margin: 0 auto 1rem;
  }

  .email-form input {
    flex: 1;
    padding: 1rem 1.5rem;
    border: 2px solid #3b82f6;
    border-radius: 12px;
    font-size: 1rem;
  }

  .email-form button {
    white-space: nowrap;
  }

  .privacy-note {
    font-size: 0.85rem;
    color: #64748b;
  }

  /* Upgrade CTA */
  .upgrade-cta {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    border-radius: 16px;
    padding: 3rem;
    margin: 3rem 0;
    color: white;
  }

  .cta-content {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 2rem;
    align-items: center;
  }

  .cta-icon {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
  }

  .cta-text h3 {
    font-size: 1.75rem;
    font-weight: 900;
    margin-bottom: 0.5rem;
  }

  .cta-text p {
    opacity: 0.95;
    margin-bottom: 1rem;
  }

  .cta-value {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .value-old {
    text-decoration: line-through;
    opacity: 0.7;
  }

  .value-new {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 700;
  }

  .cta-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .btn-cta-primary,
  .btn-cta-secondary {
    padding: 1rem 1.5rem;
    border-radius: 12px;
    font-weight: 700;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    white-space: nowrap;
    transition: all 0.3s ease;
  }

  .btn-cta-primary {
    background: white;
    color: #1e40af;
  }

  .btn-cta-primary:hover {
    transform: translateX(4px);
  }

  .btn-cta-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }

  .btn-cta-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* How It Works */
  .how-it-works {
    padding: 80px 0;
    background: white;
  }

  .how-it-works h2 {
    text-align: center;
    font-size: 2.5rem;
    font-weight: 900;
    margin-bottom: 3rem;
    color: #1e293b;
  }

  .steps-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
  }

  .step-card {
    text-align: center;
    padding: 2rem;
  }

  .step-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #3b82f6, #1e40af);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 900;
    margin: 0 auto 1.5rem;
  }

  .step-card h3 {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: #1e293b;
  }

  .step-card p {
    color: #64748b;
  }

  /* Error State */
  .error-state {
    text-align: center;
    padding: 3rem 0;
  }

  .error-state i {
    color: #ef4444;
    margin-bottom: 1.5rem;
  }

  .error-state h3 {
    font-size: 1.8rem;
    color: #1e293b;
    margin-bottom: 1rem;
  }

  .error-state p {
    color: #64748b;
    margin-bottom: 2rem;
  }

  /* New Analysis */
  .new-analysis {
    text-align: center;
    margin-top: 2rem;
  }

  .btn-secondary {
    padding: 1rem 2rem;
    background: white;
    color: #3b82f6;
    border: 2px solid #3b82f6;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-secondary:hover {
    background: #3b82f6;
    color: white;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero h1 {
      font-size: 2rem;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .vs-divider {
      margin: 0 auto;
    }

    .cta-content {
      grid-template-columns: 1fr;
      text-align: center;
    }

    .cta-actions {
      margin-top: 1rem;
    }

    .email-form {
      flex-direction: column;
    }
  }
</style>

<script define:vars={{ apiUrl }}>
  const form = document.getElementById('keywordGapForm');
  const formState = document.getElementById('formState');
  const loadingState = document.getElementById('loadingState');
  const resultsState = document.getElementById('resultsState');
  const errorState = document.getElementById('errorState');
  const emailGate = document.getElementById('emailGate');
  const fullOpportunities = document.getElementById('fullOpportunities');

  let currentResults = null;

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const yourDomain = document.getElementById('yourDomain').value.trim();
    const competitorDomain = document.getElementById('competitorDomain').value.trim();

    // Show loading
    formState.style.display = 'none';
    loadingState.style.display = 'block';
    resultsState.style.display = 'none';
    errorState.style.display = 'none';

    animateProgressSteps();

    try {
      const response = await fetch(`${apiUrl}/api/keyword-gap`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ yourDomain, competitorDomain }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Analysis failed');
      }

      currentResults = data;
      displayResults(data);

    } catch (error) {
      console.error('Analysis error:', error);
      showError(error.message);
    }
  });

  // Email form submission
  document.getElementById('emailForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = document.getElementById('email').value.trim();
    const yourDomain = document.getElementById('yourDomain').value.trim();
    const competitorDomain = document.getElementById('competitorDomain').value.trim();

    try {
      const response = await fetch(`${apiUrl}/api/keyword-gap`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ yourDomain, competitorDomain, email }),
      });

      const data = await response.json();

      if (response.ok) {
        // Hide email gate, show full list
        emailGate.style.display = 'none';
        fullOpportunities.style.display = 'block';
        displayFullOpportunities(data.opportunities);
      }

    } catch (error) {
      alert('Failed to send report. Please try again.');
    }
  });

  function animateProgressSteps() {
    const steps = ['step1', 'step2', 'step3', 'step4'];
    steps.forEach((stepId, index) => {
      setTimeout(() => {
        const step = document.getElementById(stepId);
        step.classList.add('active');
        if (index > 0) {
          const prevStep = document.getElementById(steps[index - 1]);
          prevStep.classList.remove('active');
          prevStep.classList.add('complete');
          prevStep.querySelector('i').className = 'fas fa-check-circle';
        }
      }, index * 1500);
    });
  }

  function displayResults(data) {
    loadingState.style.display = 'none';
    resultsState.style.display = 'block';

    // Domains
    document.getElementById('yourDomainMini').textContent = data.yourDomain;
    document.getElementById('competitorDomainMini').textContent = data.competitorDomain;

    // Stats
    document.getElementById('totalGaps').textContent = data.totalGaps;
    document.getElementById('easyWins').textContent = data.easyWins;
    document.getElementById('totalValue').textContent = `$${data.totalMonthlyValue.toLocaleString()}`;
    document.getElementById('fullListCount').textContent = data.easyWins;

    // Top 3 opportunities
    displayOpportunities(data.opportunities);

    // Show/hide email gate
    if (data.requiresEmail) {
      emailGate.style.display = 'block';
      fullOpportunities.style.display = 'none';
    } else {
      emailGate.style.display = 'none';
      fullOpportunities.style.display = 'block';
      displayFullOpportunities(data.opportunities);
    }
  }

  function displayOpportunities(opportunities) {
    const container = document.getElementById('opportunitiesList');
    container.innerHTML = opportunities.slice(0, 3).map((opp, index) => `
      <div class="opportunity-card">
        <div class="opportunity-header">
          <div class="opportunity-rank">${index + 1}</div>
          <div class="opportunity-main">
            <div class="keyword-text">"${opp.keyword}"</div>
            ${opp.isEasyWin ? '<span class="easy-win-badge">âš¡ Easy Win</span>' : ''}
          </div>
        </div>
        <div class="opportunity-metrics">
          <div class="metric">
            <div class="metric-value">${opp.searchVolume}</div>
            <div class="metric-label">Searches/Month</div>
          </div>
          <div class="metric">
            <div class="metric-value">$${opp.estimatedMonthlyValue.toLocaleString()}</div>
            <div class="metric-label">Monthly Value</div>
          </div>
          <div class="metric">
            <div class="metric-value">${opp.difficulty}/100</div>
            <div class="metric-label">Difficulty</div>
          </div>
          <div class="metric">
            <div class="metric-value">#${opp.competitorPosition || '?'}</div>
            <div class="metric-label">Their Position</div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function displayFullOpportunities(opportunities) {
    const container = document.getElementById('fullOpportunitiesList');
    container.innerHTML = opportunities.map((opp, index) => `
      <div class="opportunity-card">
        <div class="opportunity-header">
          <div class="opportunity-rank">${index + 1}</div>
          <div class="opportunity-main">
            <div class="keyword-text">"${opp.keyword}"</div>
            ${opp.isEasyWin ? '<span class="easy-win-badge">âš¡ Easy Win</span>' : ''}
          </div>
        </div>
        <div class="opportunity-metrics">
          <div class="metric">
            <div class="metric-value">${opp.searchVolume}</div>
            <div class="metric-label">Searches/Month</div>
          </div>
          <div class="metric">
            <div class="metric-value">$${opp.estimatedMonthlyValue.toLocaleString()}</div>
            <div class="metric-label">Monthly Value</div>
          </div>
          <div class="metric">
            <div class="metric-value">${opp.difficulty}/100</div>
            <div class="metric-label">Difficulty</div>
          </div>
          <div class="metric">
            <div class="metric-value">#${opp.competitorPosition || '?'}</div>
            <div class="metric-label">Their Position</div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function showError(message) {
    loadingState.style.display = 'none';
    errorState.style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
  }

  // Try again
  document.getElementById('tryAgainButton')?.addEventListener('click', () => {
    errorState.style.display = 'none';
    formState.style.display = 'block';
  });

  // New analysis
  document.getElementById('newAnalysisButton')?.addEventListener('click', () => {
    resultsState.style.display = 'none';
    formState.style.display = 'block';
    form.reset();
  });
</script>
