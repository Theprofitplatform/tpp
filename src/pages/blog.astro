---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';

const pageTitle = "Blog | The Profit Platform";
const pageDescription = "Digital marketing tips, strategies, and insights for Sydney businesses.";

// Fetch all published blog posts
const allPosts = await getCollection('blog', ({ data }) => {
  return !data.draft;
});

// Sort by date (newest first) - handle both pubDate and publishDate
const sortedPosts = allPosts.sort((a, b) => {
  const dateA = a.data.publishDate || a.data.pubDate;
  const dateB = b.data.publishDate || b.data.pubDate;
  return dateB.valueOf() - dateA.valueOf();
});

// Featured post (if marked, otherwise use newest)
const featuredPost = sortedPosts.find(p => p.data.featured) || sortedPosts[0];

// Recent posts for grid (exclude featured if it exists, otherwise take next 6)
const recentPosts = featuredPost && sortedPosts.find(p => p.data.featured)
  ? sortedPosts.filter(p => p !== featuredPost).slice(0, 6)
  : sortedPosts.slice(1, 7);

// Calculate category counts
const categoryCount = {};
sortedPosts.forEach(post => {
  const cat = post.data.category;
  categoryCount[cat] = (categoryCount[cat] || 0) + 1;
});

// Get unique categories
const categories = Object.keys(categoryCount).sort();

// Helper function to get gradient color for category
function getCategoryGradient(category) {
  const gradients = {
    'SEO': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    'Google Ads': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    'Web Design': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
    'Content Marketing': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
    'Digital Marketing': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
    'Analytics': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
  };
  return gradients[category] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
}

// Helper function to format date (handles both pubDate and publishDate)
function formatDate(post) {
  const date = post.data.publishDate || post.data.pubDate;
  return new Date(date).toLocaleDateString('en-AU', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// Helper function to calculate read time
function getReadTime(post) {
  return post.data.readTime || '5 min read';
}
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <link rel="stylesheet" href="/css/blog.css">
  <style>
    html {
      background: #ffffff !important;
      background-image: none !important;
    }
    body {
      background: #ffffff !important;
      background-color: #ffffff !important;
      background-image: none !important;
    }
    body::before,
    body::after,
    html::before,
    html::after {
      display: none !important;
    }
    main::before,
    main::after {
      display: none !important;
    }
    body .blog-hero {
      background: #ffffff !important;
      background-color: #ffffff !important;
      background-image: none !important;
    }
    #main-content {
      background: #ffffff !important;
      background-image: none !important;
    }
    .blog-hero {
      background: #ffffff !important;
      background-image: none !important;
    }
    .blog-hero::before,
    .blog-hero::after {
      display: none !important;
    }
    .hero-background,
    .hero-gradient-mesh,
    .hero-floating-elements,
    .hero-grid-overlay,
    .floating-orb,
    .newsletter-gradient,
    .newsletter-pattern {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
    }

    /* Remove any gradient backgrounds from hero section */
    .hero,
    [class*="hero"] {
      background-image: none !important;
    }
  </style>

  <Header />
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.body.style.backgroundColor = '#ffffff';
      document.documentElement.style.backgroundColor = '#ffffff';
    });
  </script>

  <main id="main-content" role="main">
    <!-- Hero Section -->
    <section class="blog-hero">
      <div class="hero-background">
        <div class="hero-gradient-mesh"></div>
        <div class="hero-floating-elements">
          <div class="floating-orb orb-1"></div>
          <div class="floating-orb orb-2"></div>
          <div class="floating-orb orb-3"></div>
        </div>
        <div class="hero-grid-overlay"></div>
      </div>

      <div class="container">
        <div class="hero-content">
          <span class="hero-badge">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
            </svg>
            Digital Marketing Insights
          </span>

          <h1 class="hero-title">
            Master Digital Marketing.<br/>
            <span class="gradient-text">Grow Your Business.</span>
          </h1>

          <p class="hero-description">
            Actionable strategies, proven tactics, and real-world case studies from Sydney's top digital marketing experts.
          </p>

          <div class="hero-stats">
            <div class="stat-item">
              <div class="stat-icon-wrapper">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-number">100+</span>
                <span class="stat-label">Articles</span>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon-wrapper">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-number">50K+</span>
                <span class="stat-label">Readers</span>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon-wrapper">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
              </div>
              <div class="stat-content">
                <span class="stat-number">Weekly</span>
                <span class="stat-label">Updates</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Filter Bar -->
    <section class="filter-section">
      <div class="container">
        <div class="filter-container">
          <div class="filter-search">
            <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM18 18l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <input type="search" placeholder="Search articles..." class="search-input">
          </div>

          <div class="filter-pills">
            <button class="filter-pill active" data-category="all">
              All Posts <span class="pill-count">{sortedPosts.length}</span>
            </button>
            {categories.map(category => (
              <button class="filter-pill" data-category={category.toLowerCase().replace(/\s+/g, '-')}>
                {category} <span class="pill-count">{categoryCount[category]}</span>
              </button>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- Featured Article -->
    <section class="featured-section">
      <div class="container">
        <div class="section-label">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 1l2.163 4.382L15 6.09l-3.5 3.409.826 4.817L8 12.09l-4.326 2.227.826-4.817L1 6.09l4.837-.708z"/>
          </svg>
          Featured Article
        </div>

        {featuredPost && (
          <article class="featured-article">
            <div class="featured-visual">
              <div class="visual-gradient"></div>
              <div class="featured-badge">Must Read</div>
              <div class="visual-icon">
                <svg width="64" height="64" viewBox="0 0 64 64" fill="currentColor">
                  <path d="M32 8l4 8h10l-8 8 4 10-10-6-10 6 4-10-8-8h10l4-8zm0 24c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16-7.163-16-16-16z"/>
                </svg>
              </div>
            </div>

            <div class="featured-content">
              <div class="article-meta-top">
                <span class="category-badge seo">{featuredPost.data.category}</span>
                <span class="read-time">{getReadTime(featuredPost)}</span>
              </div>

              <h2 class="featured-title">
                {featuredPost.data.title}
              </h2>

              <p class="featured-excerpt">
                {featuredPost.data.description}
              </p>

              <div class="article-meta-bottom">
                <div class="author-info">
                  <div class="author-avatar">{featuredPost.data.author === 'Avi' ? 'A' : 'TPP'}</div>
                  <div class="author-details">
                    <span class="author-name">{featuredPost.data.author}</span>
                    <span class="publish-date">{formatDate(featuredPost)}</span>
                  </div>
                </div>

                <a href={`/blog/${featuredPost.slug}`} class="featured-cta">
                  Read Article
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M4 10h12m0 0l-4-4m4 4l-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </a>
              </div>
            </div>
          </article>
        )}
      </div>
    </section>

    <!-- Latest Articles Grid -->
    <section class="articles-section">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">Latest Articles</h2>
          <div class="view-toggle">
            <button class="view-btn active">Latest</button>
            <button class="view-btn">Popular</button>
          </div>
        </div>

        <div class="articles-grid">
          {recentPosts.map(post => (
            <article class="article-card">
              <div class="article-image" style={`background: ${getCategoryGradient(post.data.category)};`}>
                <div class="image-overlay"></div>
                <div class="article-icon">
                  <svg width="32" height="32" viewBox="0 0 32 32" fill="currentColor">
                    <path d="M16 4l4 8 8 2-6 6 2 8-8-4-8 4 2-8-6-6 8-2z"/>
                  </svg>
                </div>
              </div>

              <div class="article-body">
                <span class="category-badge">{post.data.category}</span>

                <h3 class="article-title">
                  <a href={`/blog/${post.slug}`}>{post.data.title}</a>
                </h3>

                <p class="article-excerpt">
                  {post.data.description}
                </p>

                <div class="article-footer">
                  <div class="article-meta">
                    <span class="meta-date">{formatDate(post)}</span>
                    <span class="meta-divider">•</span>
                    <span class="meta-time">{getReadTime(post)}</span>
                  </div>
                  {post.data.tags && post.data.tags.length > 0 && (
                    <div class="article-tags">
                      {post.data.tags.slice(0, 2).map(tag => (
                        <span class="tag">{tag}</span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </article>
          ))}
        </div>

        <div class="load-more-container">
          <button class="load-more-btn">
            Load More Articles
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 4v12m0 0l-4-4m4 4l4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
    </section>

    <!-- Newsletter Section -->
    <section class="newsletter-section">
      <div class="newsletter-background">
        <div class="newsletter-gradient"></div>
        <div class="newsletter-pattern"></div>
      </div>

      <div class="container">
        <div class="newsletter-content">
          <div class="newsletter-icon">
            <svg width="48" height="48" viewBox="0 0 48 48" fill="currentColor">
              <path d="M40 8H8c-2.21 0-3.98 1.79-3.98 4L4 36c0 2.21 1.79 4 4 4h32c2.21 0 4-1.79 4-4V12c0-2.21-1.79-4-4-4zm0 8L24 26 8 16v-4l16 10 16-10v4z"/>
            </svg>
          </div>

          <h2 class="newsletter-title">
            Get Weekly Marketing Insights
          </h2>

          <p class="newsletter-description">
            Join 5,000+ Sydney business owners who receive actionable digital marketing tips every Tuesday. No fluff, just strategies that work.
          </p>

          <form class="newsletter-form">
            <div class="form-group">
              <input
                type="email"
                name="email"
                placeholder="Enter your email address"
                required
                class="newsletter-input"
              >
              <button type="submit" class="newsletter-submit">
                Subscribe Free
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M4 10h12m0 0l-4-4m4 4l-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
            <p class="newsletter-privacy">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 1l6 3v4c0 4-3 8-6 9-3-1-6-5-6-9V4l6-3z"/>
              </svg>
              No spam, ever. Unsubscribe with one click.
            </p>
          </form>

          <div class="newsletter-proof">
            <div class="proof-item">
              <span class="proof-number">5K+</span>
              <span class="proof-label">Subscribers</span>
            </div>
            <div class="proof-item">
              <span class="proof-number">4.9★</span>
              <span class="proof-label">Rating</span>
            </div>
            <div class="proof-item">
              <span class="proof-number">Weekly</span>
              <span class="proof-label">Delivery</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>
